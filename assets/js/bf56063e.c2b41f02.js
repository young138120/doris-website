"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["499911"],{410866:function(e,n,i){i.r(n),i.d(n,{metadata:()=>a,contentTitle:()=>s,default:()=>u,assets:()=>d,toc:()=>o,frontMatter:()=>l});var a=JSON.parse('{"id":"query-acceleration/tuning/tuning-plan/transparent-rewriting-with-async-mv","title":"Transparent Rewriting by Async-Materialized View","description":"\x3c!--","source":"@site/versioned_docs/version-3.0/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-async-mv.md","sourceDirName":"query-acceleration/tuning/tuning-plan","slug":"/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-async-mv","permalink":"/docs/3.0/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-async-mv","draft":false,"unlisted":false,"tags":[],"version":"3.0","frontMatter":{"title":"Transparent Rewriting by Async-Materialized View","language":"zh-CN"},"sidebar":"docs","previous":{"title":"Transparent Rewriting with Sync-Materialized View","permalink":"/docs/3.0/query-acceleration/tuning/tuning-plan/transparent-rewriting-with-sync-mv"},"next":{"title":"Tuning Plan with Column Statistics","permalink":"/docs/3.0/query-acceleration/tuning/tuning-plan/tuning-plan-with-statistics"}}'),t=i("785893"),r=i("250065");let l={title:"Transparent Rewriting by Async-Materialized View",language:"zh-CN"},s=void 0,d={},o=[{value:"Principle",id:"principle",level:2},{value:"Tuning Case",id:"tuning-case",level:2},{value:"1 Creation of Base Tables and Data Insertion",id:"1-creation-of-base-tables-and-data-insertion",level:3},{value:"2 Creation of Async-Materialized View",id:"2-creation-of-async-materialized-view",level:3},{value:"3 Viewing Materialized View Metadata",id:"3-viewing-materialized-view-metadata",level:3},{value:"4 Refreshing the Materialized View",id:"4-refreshing-the-materialized-view",level:3},{value:"5 Task Management",id:"5-task-management",level:3},{value:"6 Modifying the Materialized View",id:"6-modifying-the-materialized-view",level:3},{value:"7 Deleting the Materialized View",id:"7-deleting-the-materialized-view",level:3},{value:"8 Querying Using the Materialized View",id:"8-querying-using-the-materialized-view",level:3},{value:"Summary",id:"summary",level:2}];function c(e){let n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"principle",children:"Principle"}),"\n",(0,t.jsx)(n.p,{children:"The aync-materialized view adopts a transparent rewriting algorithm based on the SPJG (SELECT-PROJECT-JOIN-GROUP-BY) model. This algorithm can analyze the structural information of query SQL, automatically find suitable materialized views, and attempt transparent rewriting to utilize the optimal materialized view to express the query SQL. By using precomputed materialized view results, it can significantly improve query performance and reduce computational costs."}),"\n",(0,t.jsx)(n.h2,{id:"tuning-case",children:"Tuning Case"}),"\n",(0,t.jsx)(n.p,{children:"Next, through an example, we will demonstrate in detail how to use aync-materialized views to optimize queries. This example covers a series of operations including the creation, metadata viewing, data refreshing, task management, modification, and deletion of materialized views."}),"\n",(0,t.jsx)(n.h3,{id:"1-creation-of-base-tables-and-data-insertion",children:"1 Creation of Base Tables and Data Insertion"}),"\n",(0,t.jsxs)(n.p,{children:["First, create two tables, ",(0,t.jsx)(n.code,{children:"orders"})," and ",(0,t.jsx)(n.code,{children:"lineitem"}),", in the tpch database, and insert the corresponding data."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"CREATE DATABASE IF NOT EXISTS tpch;\n\nUSE tpch;  \n  \n-- Create the orders table  \nCREATE TABLE IF NOT EXISTS orders (  \n    o_orderkey       integer not null,  \n    o_custkey        integer not null,  \n    o_orderstatus    char(1) not null,  \n    o_totalprice     decimalv3(15,2) not null,  \n    o_orderdate      date not null,  \n    o_orderpriority  char(15) not null,  \n    o_clerk          char(15) not null,  \n    o_shippriority   integer not null,  \n    o_comment        varchar(79) not null  \n)  \nDUPLICATE KEY(o_orderkey, o_custkey)  \nPARTITION BY RANGE(o_orderdate)(  \n    FROM ('2023-10-17') TO ('2023-10-20') INTERVAL 1 DAY  \n)  \nDISTRIBUTED BY HASH(o_orderkey) BUCKETS 3  \nPROPERTIES (\"replication_num\" = \"1\");  \n  \n-- Insert data into the orders table  \nINSERT INTO orders VALUES  \n    (1, 1, 'o', 99.5, '2023-10-17', 'a', 'b', 1, 'yy'),  \n    (2, 2, 'o', 109.2, '2023-10-18', 'c','d',2, 'mm'),  \n    (3, 3, 'o', 99.5, '2023-10-19', 'a', 'b', 1, 'yy');  \n  \n-- Create the lineitem table  \nCREATE TABLE IF NOT EXISTS lineitem (  \n    l_orderkey    integer not null,  \n    l_partkey     integer not null,  \n    l_suppkey     integer not null,  \n    l_linenumber  integer not null,  \n    l_quantity    decimalv3(15,2) not null,  \n    l_extendedprice  decimalv3(15,2) not null,  \n    l_discount    decimalv3(15,2) not null,  \n    l_tax         decimalv3(15,2) not null,  \n    l_returnflag  char(1) not null,  \n    l_linestatus  char(1) not null,  \n    l_shipdate    date not null,  \n    l_commitdate  date not null,  \n    l_receiptdate date not null,  \n    l_shipinstruct char(25) not null,  \n    l_shipmode     char(10) not null,  \n    l_comment      varchar(44) not null  \n)  \nDUPLICATE KEY(l_orderkey, l_partkey, l_suppkey, l_linenumber)  \nPARTITION BY RANGE(l_shipdate)  \n(FROM ('2023-10-17') TO ('2023-10-20') INTERVAL 1 DAY)  \nDISTRIBUTED BY HASH(l_orderkey) BUCKETS 3  \nPROPERTIES (\"replication_num\" = \"1\");  \n  \n-- Insert data into the lineitem table  \nINSERT INTO lineitem VALUES  \n    (1, 2, 3, 4, 5.5, 6.5, 7.5, 8.5, 'o', 'k', '2023-10-17', '2023-10-17', '2023-10-17', 'a', 'b', 'yyyyyyyyy'),  \n    (2, 2, 3, 4, 5.5, 6.5, 7.5, 8.5, 'o', 'k', '2023-10-18', '2023-10-18', '2023-10-18', 'a', 'b', 'yyyyyyyyy'),  \n    (3, 2, 3, 6, 7.5, 8.5, 9.5, 10.5, 'k', 'o', '2023-10-19', '2023-10-19', '2023-10-19', 'c', 'd', 'xxxxxxxxx');\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-creation-of-async-materialized-view",children:"2 Creation of Async-Materialized View"}),"\n",(0,t.jsxs)(n.p,{children:["Next, create an asynchronous materialized view ",(0,t.jsx)(n.code,{children:"mv1"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"CREATE MATERIALIZED VIEW mv1   \nBUILD DEFERRED REFRESH AUTO ON MANUAL  \nPARTITION BY(l_shipdate)  \nDISTRIBUTED BY RANDOM BUCKETS 2  \nPROPERTIES ('replication_num' = '1')   \nAS   \nSELECT l_shipdate, o_orderdate, l_partkey, l_suppkey, SUM(o_totalprice) AS sum_total  \nFROM lineitem  \nLEFT JOIN orders ON lineitem.l_orderkey = orders.o_orderkey AND l_shipdate = o_orderdate  \nGROUP BY  \nl_shipdate,  \no_orderdate,  \nl_partkey,  \nl_suppkey;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-viewing-materialized-view-metadata",children:"3 Viewing Materialized View Metadata"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:'SELECT * FROM mv_infos("database"="tpch") WHERE Name="mv1";\n'})}),"\n",(0,t.jsx)(n.h3,{id:"4-refreshing-the-materialized-view",children:"4 Refreshing the Materialized View"}),"\n",(0,t.jsx)(n.p,{children:"First, view the partition list:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SHOW PARTITIONS FROM mv1;\n"})}),"\n",(0,t.jsx)(n.p,{children:"Then refresh a specific partition:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"REFRESH MATERIALIZED VIEW mv1 PARTITIONS(p_20231017_20231018);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"5-task-management",children:"5 Task Management"}),"\n",(0,t.jsx)(n.p,{children:"Manage jobs for materialized views, including viewing jobs, pausing scheduled tasks, resuming scheduled tasks, and viewing and canceling tasks."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"View materialized view jobs"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:'SELECT * FROM jobs("type"="mv") ORDER BY CreateTime;\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Pause scheduled tasks for materialized views"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"PAUSE MATERIALIZED VIEW JOB ON mv1;\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Resume scheduled tasks for materialized views"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"RESUME MATERIALIZED VIEW JOB ON mv1;\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"View materialized view tasks"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:'SELECT * FROM tasks("type"="mv");\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Cancel a materialized view task: assuming ",(0,t.jsx)(n.code,{children:"realTaskId"})," is 123"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"CANCEL MATERIALIZED VIEW TASK 123 ON mv1;\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"6-modifying-the-materialized-view",children:"6 Modifying the Materialized View"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:'ALTER MATERIALIZED VIEW mv1 SET("grace_period"="3333");\n'})}),"\n",(0,t.jsx)(n.h3,{id:"7-deleting-the-materialized-view",children:"7 Deleting the Materialized View"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"DROP MATERIALIZED VIEW mv1;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"8-querying-using-the-materialized-view",children:"8 Querying Using the Materialized View"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Direct query"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT l_shipdate, sum_total \nFROM mv1 \nWHERE l_partkey = 2 AND l_suppkey = 3;\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Query through transparent rewriting (the query optimizer automatically uses the materialized view)"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-sql",children:"SELECT l_shipdate, SUM(o_totalprice) AS total_price\nFROM lineitem\nLEFT JOIN orders ON lineitem.l_orderkey = orders.o_orderkey AND l_shipdate = o_orderdate\nWHERE l_partkey = 2 AND l_suppkey = 3\nGROUP BY l_shipdate;\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The above example fully demonstrates the lifecycle of an asynchronous materialized view, including creation, management, usage, and deletion."}),"\n",(0,t.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,t.jsx)(n.p,{children:"By utilizing materialized views, query performance can be significantly enhanced, particularly for complex aggregated queries. Several considerations should be kept in mind when using them:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Precomputed Results: Materialized views precompute and store query results, avoiding the overhead of repeated computations for each query. This is especially effective for complex queries that need to be executed frequently."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Reduction of Join Operations: Materialized views can consolidate data from multiple tables into a single view, reducing the need for join operations during queries and thereby improving query efficiency."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Automatic Updates: When the data in the base tables changes, materialized views can be automatically updated to maintain data consistency. This ensures that query results always reflect the latest data state."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Storage Overhead: Materialized views require additional storage space to save precomputed results. When creating materialized views, a trade-off between query performance improvement and storage space consumption needs to be considered."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Maintenance Cost: The maintenance of materialized views requires certain system resources and time. Frequently updated base tables may result in higher update overhead for materialized views. Therefore, it is necessary to select an appropriate refresh strategy based on actual conditions."}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Use Cases: Materialized views are suitable for scenarios where data changes infrequently but query frequency is high. For data that changes frequently, real-time computation may be more appropriate."}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The rational use of materialized views can significantly improve database query performance, especially in the case of complex queries and large data volumes. At the same time, it is also necessary to comprehensively consider factors such as storage and maintenance to achieve a balance between performance and cost."})]})}function u(e={}){let{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},250065:function(e,n,i){i.d(n,{Z:function(){return s},a:function(){return l}});var a=i(667294);let t={},r=a.createContext(t);function l(e){let n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);