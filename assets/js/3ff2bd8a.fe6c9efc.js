"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["701576"],{242890:function(e,n,i){i.r(n),i.d(n,{metadata:()=>t,contentTitle:()=>o,default:()=>u,assets:()=>r,toc:()=>d,frontMatter:()=>s});var t=JSON.parse('{"id":"admin-manual/audit-plugin","title":"Audit Log Plugin","description":"\x3c!--","source":"@site/versioned_docs/version-3.0/admin-manual/audit-plugin.md","sourceDirName":"admin-manual","slug":"/admin-manual/audit-plugin","permalink":"/docs/3.0/admin-manual/audit-plugin","draft":false,"unlisted":false,"tags":[],"version":"3.0","frontMatter":{"title":"Audit Log Plugin","language":"en"},"sidebar":"docs","previous":{"title":"partition_statistics","permalink":"/docs/3.0/admin-manual/system-tables/internal_schema/partition_statistics"},"next":{"title":"Overview","permalink":"/docs/3.0/admin-manual/open-api/overview"}}'),l=i("785893"),a=i("250065");let s={title:"Audit Log Plugin",language:"en"},o=void 0,r={},d=[{value:"Using the Audit Log Plugin",id:"using-the-audit-log-plugin",level:2},{value:"Enabling the Plugin",id:"enabling-the-plugin",level:3},{value:"Audit log table",id:"audit-log-table",level:3},{value:"Related configurations",id:"related-configurations",level:3},{value:"Audit Log Migration",id:"audit-log-migration",level:2},{value:"FAQ",id:"faq",level:2}];function c(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"This plugin can regularly import the audit logs of FE into a specified system table, making it convenient for users to view and analyze audit logs through SQL."}),"\n",(0,l.jsx)(n.h2,{id:"using-the-audit-log-plugin",children:"Using the Audit Log Plugin"}),"\n",(0,l.jsx)(n.p,{children:"Starting from Doris 2.1, the audit log plugin is integrated directly into the Doris kernel as a built-in plugin. Users do not need to install the plugin separately."}),"\n",(0,l.jsxs)(n.p,{children:["After the cluster starts, a system table named ",(0,l.jsx)(n.code,{children:"audit_log"})," will be created under the ",(0,l.jsx)(n.code,{children:"__internal_schema"})," database to store audit logs."]}),"\n",(0,l.jsx)(n.admonition,{type:"note",children:(0,l.jsx)(n.p,{children:"For versions prior to Doris 2.1, please refer to the 2.0 version documentation."})}),"\n",(0,l.jsx)(n.admonition,{type:"warning",children:(0,l.jsxs)(n.p,{children:["After upgrading to version 2.1, the original audit log plugin will be unavailable. Refer to the ",(0,l.jsx)(n.strong,{children:"Audit Log Migration"})," section to see how to migrate audit log table data."]})}),"\n",(0,l.jsx)(n.h3,{id:"enabling-the-plugin",children:"Enabling the Plugin"}),"\n",(0,l.jsxs)(n.p,{children:["The audit log plugin can be enabled or disabled at any time using the global variable ",(0,l.jsx)(n.code,{children:"enable_audit_plugin"})," (default is disabled), for example:"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"set global enable_audit_plugin = true;"})}),"\n",(0,l.jsxs)(n.p,{children:["Once enabled, Doris will write the enabled audit logs to the ",(0,l.jsx)(n.code,{children:"audit_log"})," table."]}),"\n",(0,l.jsx)(n.p,{children:"The audit log plugin can be disabled at any time:"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:"set global enable_audit_plugin = false;"})}),"\n",(0,l.jsxs)(n.p,{children:["After disabling, Doris will stop writing to the ",(0,l.jsx)(n.code,{children:"audit_log"})," table. The existing audit logs will not be affected."]}),"\n",(0,l.jsx)(n.h3,{id:"audit-log-table",children:"Audit log table"}),"\n",(0,l.jsxs)(n.p,{children:["With the upgrade of Doris version, the fields of the audit log table will also increase. For details, please refer to ",(0,l.jsx)(n.a,{href:"/docs/3.0/admin-manual/system-tables/internal_schema/audit_log",children:"audit_log"})]}),"\n",(0,l.jsxs)(n.p,{children:["Starting from version 2.1.8 and 3.0.3, the ",(0,l.jsx)(n.code,{children:"audit_log"})," system table will automatically add new fields of ",(0,l.jsx)(n.code,{children:"audit_log"})," table as the Doris version is upgraded."]}),"\n",(0,l.jsxs)(n.p,{children:["In previous versions, users need to manually add fields to the ",(0,l.jsx)(n.code,{children:"audit_log"})," system table through the ",(0,l.jsx)(n.code,{children:"ALTER TABLE"})," command."]}),"\n",(0,l.jsx)(n.h3,{id:"related-configurations",children:"Related configurations"}),"\n",(0,l.jsx)(n.p,{children:"The audit log table is a dynamic partitioned table, partitioned by day, and retains data for the last 30 days by default."}),"\n",(0,l.jsx)(n.p,{children:"The following global variables can control some writing behaviors of the audit log table:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"audit_plugin_max_batch_interval_sec"}),": The maximum write interval for the audit log table. Default is 60 seconds."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"audit_plugin_max_batch_bytes"}),": The maximum amount of data written per batch to the audit log table. Default is 50MB."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"audit_plugin_max_sql_length"}),": The maximum length of statements recorded in the audit log table. Default is 4096."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.code,{children:"audit_plugin_load_timeout"}),": Default timeout for the audit log import job. Default is 600 seconds."]}),"\n"]}),"\n",(0,l.jsxs)(n.p,{children:["These can be set using ",(0,l.jsx)(n.code,{children:"set global xxx=yyy"}),"."]}),"\n",(0,l.jsx)(n.p,{children:"FE Configuration:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.code,{children:"skip_audit_user_list"})," (supported since 3.0.1)"]}),"\n",(0,l.jsx)(n.p,{children:"If you do not want the operations of certain users to be recorded in the audit log, you can modify this configuration."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"skip_audit_user_list=root\n-- or\nskip_audit_user_list=user1,user2\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"audit-log-migration",children:"Audit Log Migration"}),"\n",(0,l.jsx)(n.p,{children:"After upgrading to version 2.1, the original audit log plugin will be unavailable. This section explains how to migrate data from the original audit log table to the new audit log table."}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Confirm the field information of the old and new audit log tables."}),"\n",(0,l.jsxs)(n.p,{children:["The default audit log table should be ",(0,l.jsx)(n.code,{children:"doris_audit_db__"}),".",(0,l.jsx)(n.code,{children:"doris_audit_log_tbl__"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["The new audit log table is ",(0,l.jsx)(n.code,{children:"__internal_schema"}),".",(0,l.jsx)(n.code,{children:"audit_log"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["You can check if the field information of the two tables matches by using the ",(0,l.jsx)(n.code,{children:"DESC table_name"})," command. Typically, the fields of the old table should be a subset of the new table."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Migrate Audit Log Table Data"}),"\n",(0,l.jsx)(n.p,{children:"You can use the following statement to migrate data from the original table to the new table:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"INSERT INTO __internal_schema.audit_log (\n    query_id         ,\n    time             ,\n    client_ip        ,\n    user             ,\n    db               ,\n    state            ,\n    error_code       ,\n    error_message    ,\n    query_time       ,\n    scan_bytes       ,\n    scan_rows        ,\n    return_rows      ,\n    stmt_id          ,\n    is_query         ,\n    frontend_ip      ,\n    cpu_time_ms      ,\n    sql_hash         ,\n    sql_digest       ,\n    peak_memory_bytes,\n    stmt\n    )\n    SELECT\n    query_id         ,\n    time             ,\n    client_ip        ,\n    user             ,\n    db               ,\n    state            ,\n    error_code       ,\n    error_message    ,\n    query_time       ,\n    scan_bytes       ,\n    scan_rows        ,\n    return_rows      ,\n    stmt_id          ,\n    is_query         ,\n    frontend_ip      ,\n    cpu_time_ms      ,\n    sql_hash         ,\n    sql_digest       ,\n    peak_memory_bytes,\n    stmt\n    FROM doris_audit_db__.doris_audit_log_tbl__;\n"})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Remove Original Plugin"}),"\n",(0,l.jsxs)(n.p,{children:["After migration, you can remove the original plugin by using the ",(0,l.jsx)(n.code,{children:"UNINSTALL PLUGIN AuditLoader;"})," command."]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"No data in the audit log table, or no new data is being ingested after running for a period of time"}),"\n",(0,l.jsx)(n.p,{children:"You can troubleshoot by following these steps:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsx)(n.p,{children:"Check if partitions are created correctly"}),"\n",(0,l.jsx)(n.p,{children:"The audit log table is a dynamic partition table partitioned by day. By default, it creates partitions for the next 3 days and retains historical partitions for 30 days. Data can only be written to the audit log if partitions are created correctly."}),"\n",(0,l.jsxs)(n.p,{children:["You can check the scheduling status of dynamic partitions by using ",(0,l.jsx)(n.code,{children:"show dynamic partition tables from __internal_schema"})," and troubleshoot based on error reasons. Possible error reasons may include:"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Number of nodes is less than the required replication number: The audit log table defaults to 3 replicas, so at least 3 BE nodes are required. You can modify the replication number using the ",(0,l.jsx)(n.code,{children:"alter table"})," statement, for example:"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.code,{children:'alter table __internal_schema.audit_log set ("dynamic_partition.replication_num" = "2")'})}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["No suitable storage medium: You can check the ",(0,l.jsx)(n.code,{children:"storage_medium"})," property by using ",(0,l.jsx)(n.code,{children:"show create table __internal_schema.audit_log"}),". If there is no corresponding storage medium on the BE, partition creation may fail."]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["No suitable resource group: The audit log table defaults to the default resource group. You can check if the resource group has enough node resources by using the ",(0,l.jsx)(n.code,{children:"show backends"})," command."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:["\n",(0,l.jsxs)(n.p,{children:["Search for ",(0,l.jsx)(n.code,{children:"AuditLoad"})," in the ",(0,l.jsx)(n.code,{children:"fe.log"})," on the Master FE to see if there are any related error logs"]}),"\n",(0,l.jsxs)(n.p,{children:["The audit log is imported into the table through internal stream load operations. If there are issues with the import process, error logs will be printed in the ",(0,l.jsx)(n.code,{children:"fe.log"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function u(e={}){let{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}},250065:function(e,n,i){i.d(n,{Z:function(){return o},a:function(){return s}});var t=i(667294);let l={},a=t.createContext(l);function s(e){let n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);