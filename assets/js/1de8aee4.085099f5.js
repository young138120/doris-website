"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([["683007"],{485600:function(e,n,t){t.r(n),t.d(n,{metadata:()=>r,contentTitle:()=>a,default:()=>h,assets:()=>l,toc:()=>d,frontMatter:()=>s});var r=JSON.parse('{"id":"admin-manual/cluster-management/upgrade","title":"Cluster upgrade","description":"\x3c!--","source":"@site/versioned_docs/version-1.2/admin-manual/cluster-management/upgrade.md","sourceDirName":"admin-manual/cluster-management","slug":"/admin-manual/cluster-management/upgrade","permalink":"/docs/1.2/admin-manual/cluster-management/upgrade","draft":false,"unlisted":false,"tags":[],"version":"1.2","frontMatter":{"title":"Cluster upgrade","language":"en"},"sidebar":"docs","previous":{"title":"SYNC","permalink":"/docs/1.2/sql-manual/sql-reference/Utility-Statements/SYNC"},"next":{"title":"Elastic scaling","permalink":"/docs/1.2/admin-manual/cluster-management/elastic-expansion"}}'),i=t("785893"),o=t("250065");let s={title:"Cluster upgrade",language:"en"},a="Cluster upgrade",l={},d=[{value:"Preparen",id:"preparen",level:2},{value:"Test the correctness of BE upgrade",id:"test-the-correctness-of-be-upgrade",level:2},{value:"Testing FE Metadata Compatibility",id:"testing-fe-metadata-compatibility",level:2},{value:"Upgrade preparation",id:"upgrade-preparation",level:2},{value:"rolling upgrade",id:"rolling-upgrade",level:2},{value:"About version rollback",id:"about-version-rollback",level:2}];function c(e){let n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",version:"version",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"cluster-upgrade",children:"Cluster upgrade"})}),"\n",(0,i.jsx)(n.p,{children:"Doris can upgrade smoothly by rolling upgrades. The following steps are recommended for security upgrade."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["The name of the BE binary that appears in this doc is ",(0,i.jsx)(n.code,{children:"doris_be"}),", which was ",(0,i.jsx)(n.code,{children:"palo_be"})," in previous versions."]})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Note:"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Doris does not support upgrading across two-digit version numbers, for example: you cannot upgrade directly from 0.13 to 0.15, only through 0.13.x -> 0.14.x -> 0.15.x, and the three-digit version number can be upgraded across versions, such as from 0.13 .15 can be directly upgraded to 0.14.13.1, it is not necessary to upgrade 0.14.7 or 0.14.12.1"}),"\n",(0,i.jsx)(n.li,{children:"The following approaches are based on highly available deployments. That is, data 3 replicas, FE high availability."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"preparen",children:"Preparen"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Turn off the replica repair and balance operation."}),"\n",(0,i.jsx)(n.p,{children:"There will be node restarts during the upgrade process, so unnecessary cluster balancing and replica repair logic may be triggered. You can close it first with the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'# Turn off the replica ealance logic. After it is closed, the balancing operation of the ordinary table replica will no longer be triggered.\n$ mysql-client> admin set frontend config("disable_balance" = "true");\n\n# Turn off the replica balance logic of the colocation table. After it is closed, the replica redistribution operation of the colocation table will no longer be triggered.\n$ mysql-client> admin set frontend config("disable_colocate_balance" = "true");\n\n# Turn off the replica scheduling logic. After shutting down, all generated replica repair and balancing tasks will no longer be scheduled.\n$ mysql-client> admin set frontend config("disable_tablet_scheduler" = "true");\n'})}),"\n",(0,i.jsx)(n.p,{children:"After the cluster is upgraded, just use the above command to set the corresponding configuration to the original value."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"important! ! Metadata needs to be backed up before upgrading(The entire directory needs to be backed up)! !"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"test-the-correctness-of-be-upgrade",children:"Test the correctness of BE upgrade"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Arbitrarily select a BE node and deploy the latest doris_be binary file."}),"\n",(0,i.jsx)(n.li,{children:"Restart the BE node and check the BE log be.INFO to see if the boot was successful."}),"\n",(0,i.jsxs)(n.li,{children:["If the startup fails, you can check the reason first. If the error is not recoverable, you can delete the BE directly through DROP BACKEND, clean up the data, and restart the BE using the previous version of doris_be. Then re-ADD BACKEND. (",(0,i.jsx)(n.strong,{children:"This method will result in the loss of a copy of the data, please make sure that three copies are complete, and perform this operation!!!"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:["Install Java UDF function\n",(0,i.jsx)(n.version,{since:"1.2.0",children:"Install Java UDF function: "}),", because Java UDF function is supported from version 1.2, you need to download the JAR package of Java UDF function from the official website and put it in the lib directory of BE, otherwise it may will fail to start."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"testing-fe-metadata-compatibility",children:"Testing FE Metadata Compatibility"}),"\n",(0,i.jsxs)(n.ol,{start:"0",children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Important! Exceptional metadata compatibility is likely to cause data cannot be restored!!"})}),"\n",(0,i.jsx)(n.li,{children:"Deploy a test FE process (It is recommended to use your own local development machine, or BE node. If it is on the Follower or Observer node, you need to stop the started process, but it is not recommended to test on the Follower or Observer node) using the new version alone."}),"\n",(0,i.jsxs)(n.li,{children:["Modify the FE configuration file fe.conf for testing and set all ports to ",(0,i.jsx)(n.strong,{children:"different from online"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Add configuration in fe.conf: cluster_id=123456"}),"\n",(0,i.jsx)(n.li,{children:"Add configuration in fe.conf: metadata_failure_recovery=true"}),"\n",(0,i.jsx)(n.li,{children:"Copy the metadata directory doris-meta of the online environment master Fe to the test environment\n6.The cluster_ID where copy to the doris-meta/image/VERSION file in the test environment is modified to 123456 (that is, the same as in Step 3)"}),"\n",(0,i.jsx)(n.li,{children:"In the test environment,running sh sh bin/start_fe.sh,start FE."}),"\n",(0,i.jsx)(n.li,{children:"Observe whether the start-up is successful through FE log fe.log."}),"\n",(0,i.jsx)(n.li,{children:"If the startup is successful, run sh bin/stop_fe.sh to stop the FE process of the test environment."}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"The purpose of the above 2-6 steps is to prevent the FE of the test environment from being misconnected to the online environment after it starts."})}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note:"}),"\n1.1.x Before upgrading 1.2.x, you need to delete existing Native UDF ; otherwise, FE startup fails ; And since version 1.2 no longer supports Native UDF, please use ",(0,i.jsx)(n.a,{href:"../../ecosystem/udf/java-user-defined-function.md",children:"Java UDF"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"upgrade-preparation",children:"Upgrade preparation"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"After data validation, the new version of BE and FE binary files are distributed to their respective directories."}),"\n",(0,i.jsx)(n.li,{children:"In principle, the version upgrade needs to replace the lib directory and bin directory of FE and BE, and other directories except conf directory, data directory (doris-meta of FE, storage of BE), and log directory."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"rolling-upgrade",children:"rolling upgrade"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Confirm that the new version of the file is deployed. Restart FE and BE instances one by one."}),"\n",(0,i.jsx)(n.li,{children:"It is suggested that BE be restarted one by one and FE be restarted one by one. Because Doris usually guarantees backward compatibility between FE and BE, that is, the old version of FE can access the new version of BE. However, the old version of BE may not be supported to access the new version of FE."}),"\n",(0,i.jsx)(n.li,{children:"It is recommended to restart the next instance after confirming the previous instance started successfully. Refer to the Installation Deployment Document for the identification of successful instance startup."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"about-version-rollback",children:"About version rollback"}),"\n",(0,i.jsx)(n.p,{children:"Because the database is a stateful service, Doris cannot support version rollback (version downgrade) in most cases. In some cases, the rollback of the 3-bit or 4-bit version can be supported, but the rollback of the 2-bit version will not be supported."}),"\n",(0,i.jsx)(n.p,{children:"Therefore, it is recommended to upgrade some nodes and observe the business operation (gray upgrade) to reduce the upgrade risk."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Illegal rollback operation may cause data loss and damage."})})]})}function h(e={}){let{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},250065:function(e,n,t){t.d(n,{Z:function(){return a},a:function(){return s}});var r=t(667294);let i={},o=r.createContext(i);function s(e){let n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);